@model IList<MVC.Models.Student>
@{
    ViewBag.Title = "学生列表";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>学生列表</title>

    <!-- 引用 layui -->
    <link href="~/Content/layui/css/layui.css" rel="stylesheet">

    <!-- 引用全局样式 + 学生列表专属样式 -->
    <link href="~/Content/Site.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/Student/StudentList.css" rel="stylesheet" type="text/css" />

    <style>
        .container {
            padding: 15px;
        }

        .header-toolbar {
            margin-bottom: 15px;
        }

        .layui-table th {
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 工具栏 -->
        <div class="header-toolbar">
            <button type="button" class="layui-btn layui-btn-normal" onclick="openAddDialog()">
                <i class="layui-icon">&#xe608;</i> 添加学生
            </button>
        </div>

        <!-- 学生列表 -->
        <table class="layui-table">
            <thead>
                <tr>
                    <th width="80">ID</th>
                    <th>姓名</th>
                    <th width="100">性别</th>
                    <th width="100">年龄</th>
                    <th>班级</th>
                    <th width="200">操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (MVC.Models.Student s in Model)
                {
                    <tr>
                        <td style="text-align: center;">@s.ID</td>
                        <td>@s.Name</td>
                        <td style="text-align: center;">@s.Sex</td>
                        <td style="text-align: center;">@s.Age</td>
                        <td>@s.Class</td>
                        <td style="text-align: center;">
                            <button class="layui-btn layui-btn-xs" onclick="editStudent(@s.ID)">
                                <i class="layui-icon">&#xe642;</i> 编辑
                            </button>
                            <button class="layui-btn layui-btn-danger layui-btn-xs" onclick="deleteStudent(@s.ID, '@s.Name')">
                                <i class="layui-icon">&#xe640;</i> 删除
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 引入 layui.js -->
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Scripts/jquery-3.6.0.min.js"></script>

    <script>
        // 打开添加学生弹窗
        function openAddDialog() {
            layui.use('layer', function() {
                var layer = layui.layer;

                layer.open({
                    type: 2,
                    title: false,
                    area: ['500px', '450px'],
                    maxmin: false,
                    closeBtn: 0,
                    content: '@Url.Action("Add", "Student")',
                    success: function(layero, index) {
                        // 弹窗加载成功后的回调
                    },
                    end: function() {
                        // 弹窗关闭后刷新页面
                        window.location.reload();
                    }
                });
            });
        }

        // 编辑学生
        function editStudent(id) {
            layui.use('layer', function() {
                var layer = layui.layer;

                layer.open({
                    type: 2,
                    title: false,
                    area: ['500px', '450px'],
                    maxmin: false,
                    closeBtn: 0,
                    content: '@Url.Action("Update", "Student")' + '?id=' + id,
                    success: function(layero, index) {
                        // 弹窗加载成功后的回调
                    },
                    end: function() {
                        // 弹窗关闭后刷新页面
                        window.location.reload();
                    }
                });
            });
        }
  function deleteStudent(id, name) {
    layui.use(['layer', 'jquery'], function() {
        var layer = layui.layer;
        var $ = layui.$;

        // 显示确认提示
        layer.confirm('确定要删除学生 【' + name + '】 吗？', {
            title: '删除确认',
            icon: 3,
            btn: ['确定', '取消']
        }, function(index) {
            // 用户点击了"确定"
            layer.close(index);

            // 显示加载中提示
            var loadingIndex = layer.load(1, {
                shade: [0.1, '#fff']
            });

            // 创建隐藏表单
            var form = $('<form method="post" style="display:none;"></form>');
            form.attr('action', '@Url.Action("Delete", "Student")');
            form.attr('id', 'deleteForm_' + id);

            // 添加ID字段
            var idInput = $('<input type="hidden" name="id" />');
            idInput.val(id);
            form.append(idInput);

            // 添加防伪令牌
            var tokenHtml = '@Html.AntiForgeryToken()';
            form.append($(tokenHtml));

            // 添加到页面并提交
            $('body').append(form);

            // 提交表单
            form.submit();

            // 设置一个超时检测，如果页面没有重载，显示成功提示
            setTimeout(function() {
                layer.close(loadingIndex);

                // 检查表单是否已提交并移除
                var formExists = $('#deleteForm_' + id).length > 0;
                if (!formExists) {
                    // 表单已提交，显示成功提示并刷新页面
                    layer.msg('删除成功', { icon: 1 });
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                } else {
                    // 表单还存在，可能提交失败
                    layer.msg('删除失败，请重试', { icon: 2 });
                    $('#deleteForm_' + id).remove(); // 清理表单
                }
            }, 2000);

        }, function(index) {
            // 用户点击了"取消"，关闭提示框
            layer.close(index);
        });
    });
}


    </script>
</body>
</html>