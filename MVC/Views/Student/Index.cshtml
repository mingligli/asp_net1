@model IList<MVC.Models.Student>
@{
    ViewBag.Title = "学生列表";
    int totalCount = ViewBag.TotalCount;
    int currentPage = ViewBag.CurrentPage;
    int pageSize = ViewBag.PageSize;
    int totalPages = ViewBag.TotalPages;
}

<link href="~/Content/layui/css/layui.css" rel="stylesheet" />

<style>
    .container {
        padding: 15px;
        max-height: calc(100vh - 120px);
        box-sizing: border-box;
    }

    .header-toolbar {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-box {
        display: flex;
        gap: 10px;
        margin-left: auto;
        align-items: center;
    }

    .layui-input-inline {
        margin-right: 10px;
    }

    /* 允许列拖动的关键样式 */
    .layui-table {
        width: auto !important;
        min-width: 100%;
    }

        .layui-table th {
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }

    /* 拖动分隔线 */
    .resizable-handle {
        position: absolute;
        right: 0;
        top: 0;
        width: 1px;
        height: 100%;
        background: rgba(0,0,0,0.05);
        cursor: col-resize;
        z-index: 99;
    }

    .hide-column {
        display: none !important;
    }

    .table-scroll-container {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e6e6e6;
        border-radius: 4px;
        margin-bottom: 15px;
    }

        .table-scroll-container .layui-table {
            margin: 0;
            width: 100%;
        }

    .pagination-container {
        margin-top: 20px;
        text-align: right;
    }
</style>

<div class="container">
    <div class="header-toolbar">
        <button class="layui-btn layui-btn-normal" onclick="openAddDialog()">
            <i class="layui-icon">&#xe608;</i> 添加学生
        </button>
        <div class="search-box">
            <div class="layui-input-inline">
                <input type="text" id="classFilter" list="classOptions" placeholder="按班级筛选" class="layui-input" onchange="filterByClass()" style="width:150px;">
                <datalist id="classOptions">
                    <option value="全部"></option>
                    @using (var db = new MVC.Models.studyCEntities1())
                    {
                        var cls = db.Student.Select(s => s.Class).Distinct().ToList();
                        foreach (var c in cls)
                        {
                            <option value="@c">@c</option>
}
                    }
                </datalist>
            </div>
            <div class="layui-input-inline">
                <input type="text" id="sexFilter" list="sexOptions" placeholder="按性别筛选" class="layui-input" onchange="filterBySex()" style="width:120px;">
                <datalist id="sexOptions">
                    <option value="全部">全部</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                </datalist>
            </div>
            <button class="layui-btn layui-btn-primary" onclick="resetFilters()">重置筛选</button>
        </div>
    </div>

    <div class="table-scroll-container">
        <table class="layui-table" id="studentTable">
            <thead>
                <tr>
                    <th width="60">行号</th>
                    <th width="80" class="hide-column">ID</th>
                    <th>姓名</th>
                    <th width="100">性别</th>
                    <th width="100">年龄</th>
                    <th>班级</th>
                    <th width="200">操作</th>
                </tr>
            </thead>
            <tbody>
                @{int rowNum = 1;}
                @foreach (var s in Model)
                {
                    <tr data-class="@s.Class" data-sex="@s.Sex">
                        <td style="text-align:center">@rowNum</td>
                        <td style="text-align:center" class="hide-column">@s.ID</td>
                        <td>@s.Name</td>
                        <td style="text-align:center">@s.Sex</td>
                        <td style="text-align:center">@s.Age</td>
                        <td>@s.Class</td>
                        <td style="text-align:center">
                            <button class="layui-btn layui-btn-xs" onclick="editStudent(@s.ID)">编辑</button>
                            <button class="layui-btn layui-btn-danger layui-btn-xs" onclick="deleteStudent(@s.ID,'@s.Name')">删除</button>
                        </td>
                    </tr>
                    rowNum++;
                }
                @if (Model.Count == 0)
                {
                    <tr><td colspan="7" style="text-align:center">暂无数据</td></tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination-container" id="pagination"></div>
</div>

@section Scripts {
    <script src="~/Content/layui/layui.js"></script>
    <script>
        layui.use(['laypage', 'layer', 'jquery'], function () {
            var $ = layui.$;
            var laypage = layui.laypage;
            var layer = layui.layer;

            // 分页
            laypage.render({
                elem: 'pagination',
                count: @totalCount,
                limit: @pageSize,
                curr: @currentPage,
                layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip'],
                limits: [5, 10, 20, 50],
                jump: function (obj, first) {
                    if (!first) {
                        location.href = '@Url.Action("Index","Student")?page=' + obj.curr + '&pageSize=' + obj.limit;
                    }
                }
            });

            // =========== 列宽拖动核心 ===========
            function initTableResize() {
                var th = $('#studentTable th');
                th.css({ position: 'relative' });

                th.each(function () {
                    if ($(this).hasClass('hide-column')) return;
                    $('<div class="resizable-handle"></div>').appendTo($(this));
                });

                var startX, startWidth, currentTh;
                $(document).on('mousedown', '.resizable-handle', function (e) {
                    e.preventDefault();
                    currentTh = $(this).parent('th');
                    startX = e.pageX;
                    startWidth = currentTh.width();
                    $(document).on('mousemove', mousemove);
                    $(document).on('mouseup', mouseup);
                });

                function mousemove(e) {
                    var width = startWidth + (e.pageX - startX);
                    if (width >= 60) currentTh.width(width);
                }

                function mouseup() {
                    $(document).off('mousemove', mousemove);
                    $(document).off('mouseup', mouseup);
                }
            }
            initTableResize();
            // =========== 列宽拖动结束 ===========

            // =========== 修复后的筛选逻辑 ===========
            // 按班级筛选
            function filterByClass() {
                var selectedClass = document.getElementById('classFilter').value;
                var rows = document.querySelectorAll('#studentTable tbody tr');
                var visibleCount = 0;
                var currentRowNum = 1;

                rows.forEach(function (row) {
                    // 排除暂无数据的行
                    if (row.cells.length === 1 && row.cells[0].colSpan === 7) return;

                    var rowClass = row.getAttribute('data-class');
                    var sexFilter = document.getElementById('sexFilter').value;
                    var rowSex = row.getAttribute('data-sex');

                    // 判断是否显示该行
                    var showByClass = (selectedClass === '' || selectedClass === '全部' || rowClass === selectedClass);
                    var showBySex = (sexFilter === '' || sexFilter === '全部' || rowSex === sexFilter);

                    if (showByClass && showBySex) {
                        row.style.display = '';
                        // 更新行号
                        row.cells[0].textContent = currentRowNum++;
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // 按性别筛选
            function filterBySex() {
                var selectedSex = document.getElementById('sexFilter').value;
                var rows = document.querySelectorAll('#studentTable tbody tr');
                var visibleCount = 0;
                var currentRowNum = 1;

                rows.forEach(function (row) {
                    // 排除暂无数据的行
                    if (row.cells.length === 1 && row.cells[0].colSpan === 7) return;

                    var rowSex = row.getAttribute('data-sex');
                    var classFilter = document.getElementById('classFilter').value;
                    var rowClass = row.getAttribute('data-class');

                    // 判断是否显示该行
                    var showBySex = (selectedSex === '' || selectedSex === '全部' || rowSex === selectedSex);
                    var showByClass = (classFilter === '' || classFilter === '全部' || rowClass === classFilter);

                    if (showBySex && showByClass) {
                        row.style.display = '';
                        // 更新行号
                        row.cells[0].textContent = currentRowNum++;
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // 重置筛选
            function resetFilters() {
                document.getElementById('classFilter').value = '';
                document.getElementById('sexFilter').value = '';

                var rows = document.querySelectorAll('#studentTable tbody tr');
                var currentRowNum = 1;

                rows.forEach(function (row) {
                    // 排除暂无数据的行
                    if (row.cells.length === 1 && row.cells[0].colSpan === 7) return;

                    row.style.display = '';
                    // 恢复行号
                    row.cells[0].textContent = currentRowNum++;
                });
            }
            // =========== 筛选逻辑结束 ===========

            // 暴露函数到全局，确保onchange能调用
            window.filterByClass = filterByClass;
            window.filterBySex = filterBySex;
            window.resetFilters = resetFilters;

            // 增删改功能
            window.openAddDialog = function () {
                layer.open({ type:2, title:false, area:['500px','450px'], closeBtn:0, content:'@Url.Action("Add","Student")', end:function(){location.reload();} });
            };

            window.editStudent = function (id) {
                layer.open({ type:2, title:false, area:['500px','450px'], closeBtn:0, content:'@Url.Action("Update","Student")?id='+id, end:function(){location.reload();} });
            };

            window.deleteStudent = function (id,name) {
                layer.confirm('确定删除【'+name+'】？', function(){
                    var f = $('<form method="post" style="display:none"></form>').attr('action','@Url.Action("Delete","Student")');
                    f.append('<input name="id" value="'+id+'">');
                    f.append('@Html.AntiForgeryToken()');
                    $('body').append(f);
                    f.submit();
                });
            };
        });
    </script>
}